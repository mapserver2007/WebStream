<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Webstream by webstream-framework</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Webstream</h1>
      <h2 class="project-tagline">MVC+ServiceによるWebアプリケーションフレームワーク</h2>
      <a href="https://github.com/webstream-framework/WebStream" class="btn">View on GitHub</a>
      <a href="https://github.com/webstream-framework/WebStream/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/webstream-framework/WebStream/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="webstream" class="anchor" href="#webstream" aria-hidden="true"><span class="octicon octicon-link"></span></a>WebStream</h1>

<p>WebStreamはMVCアーキテクチャをベースとしたWebアプリケーションフレームワークです。<br>
さらにS(Service)層を追加した4層構造のアーキテクチャとなっています。</p>

<h2>
<a id="webstreamのアーキテクチャ" class="anchor" href="#webstream%E3%81%AE%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3" aria-hidden="true"><span class="octicon octicon-link"></span></a>WebStreamのアーキテクチャ</h2>

<p>WebStreamはMVCを拡張したアーキテクチャを採用しており、Serviceレイヤを追加しています。<br>
MVCはFat Controller/Fat Model問題を引き起こしやすいアーキテクチャであるため、ビジネスロジックはServiceに定義します。<br>
また、View内でビジネスロジックを書く場合はHelperを利用し、Viewはレンダリングに専念させます。</p>

<h2>
<a id="controller" class="anchor" href="#controller" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="#controller">Controller</a>
</h2>

<p>Contollerではクライアントからのリクエストを受け付け、ServiceまたはModelを呼び出します。<br>
Controllerの処理が完了したらViewを呼び出します。Viewへパラメータを渡す場合、Serviceにセットします。<br>
原則的にControllerにビジネスロジックを記述してはなりません。<br>
<code>app/controllers</code>に<code>WebStream\Core\CoreController</code>クラスを継承したクラスを定義します。</p>

<h3>
<a id="controllerクラスの定義" class="anchor" href="#controller%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AE%E5%AE%9A%E7%BE%A9" aria-hidden="true"><span class="octicon octicon-link"></span></a>Controllerクラスの定義</h3>

<p>Controllerクラスは<code>\WebStream\Core\CoreController</code>クラスを継承します。<br>
ControllerクラスからはServiceクラスまたはModelクラスを参照できます。またViewテンプレートを呼び出して描画できます。</p>

<h4>
<a id="serviceクラスmodelクラス呼び出し" class="anchor" href="#service%E3%82%AF%E3%83%A9%E3%82%B9model%E3%82%AF%E3%83%A9%E3%82%B9%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97" aria-hidden="true"><span class="octicon octicon-link"></span></a>Serviceクラス、Modelクラス呼び出し</h4>

<p>Serviceクラス、Modelクラスは以下のように呼び出します。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">MyBlog</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Core\CoreController</span>;</span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">BlogController</span> <span class="pl-k">extends</span> <span class="pl-e">CoreController</span> {</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-c1">funciton</span> execute() {</span>
<span class="pl-s1">        <span class="pl-c">// $this-&gt;{ページ名}-&gt;(Service|Modelクラスのメソッド)</span></span>
<span class="pl-s1">        <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">Blog</span><span class="pl-k">-&gt;</span>entry();</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<p>Controllerクラス内の<code>$this-&gt;{ページ名}</code>オブジェクトにはServiceクラスまたはModelクラスのインスタンスが格納されています。<br>
Serviceクラスを定義している場合はServiceクラスインスタンスが格納されます。このときのページ名はアッパーキャメルケースで指定します。<br>
Serviceクラスを定義せずModelクラスのみ定義した場合はModelクラスインスタンスが格納されます。Serviceクラスに特段のビジネスロジックを記述する必要がなく、DBからのデータを取り出したいだけの場合など、Controllerクラスから直接Modelクラスにアクセスすることができます。<br>
Controllerクラスでは<a href="#annotaion">アノテーション</a>を使ってメソッドやプロパティを操作できます。</p>

<h4>
<a id="viewテンプレート呼び出し" class="anchor" href="#view%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97" aria-hidden="true"><span class="octicon octicon-link"></span></a>Viewテンプレート呼び出し</h4>

<p>HTMLを描画するにはControllerからViewテンプレートを呼び出します。Viewテンプレート呼び出しは<a href="#annotaion">アノテーション</a>を利用します。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">MyBlog</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Core\CoreController</span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-c">/**</span></span>
<span class="pl-s1"><span class="pl-c"> * @Inject</span></span>
<span class="pl-s1"><span class="pl-c"> * @Template("index.tmpl")</span></span>
<span class="pl-s1"><span class="pl-c"> */</span></span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">BlogController</span> <span class="pl-k">extends</span> <span class="pl-e">CoreController</span> {</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-c1">funciton</span> execute() {</span>
<span class="pl-s1">        <span class="pl-c">// $this-&gt;{ページ名}-&gt;(Service|Modelクラスのメソッド)</span></span>
<span class="pl-s1">        <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">Blog</span><span class="pl-k">-&gt;</span>entry();</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<p>この処理で<code>@Template</code>に指定したテンプレートファイル<code>index.tmpl</code>を呼び出します。<br>
テンプレートファイルは<code>app/views/(ページ名)/</code>に保存します。このときのページ名はスネークケースで指定します(詳細は<a href="#view">View</a>で説明します)。</p>

<h2>
<a id="service" class="anchor" href="#service" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="#service">Service</a>
</h2>

<p>ServiceクラスではContollerクラスから受け取ったリクエストやデータを使って処理をしたり、View経由でビジネスロジックを実行します。<br>
メインとなるビジネスロジックはServiceに記述します。データベースへの問い合わせが必要な場合はModelへ問い合わせます。<br>
また、Serviceでは開発者が個別に定義したクラス(ライブラリ)を利用することができます。Serviceで処理するロジックがない場合などはServiceを定義する必要はありません。<br>
<code>app/services</code>に<code>WebStream\Core\CoreService</code>クラスを継承したクラスを定義します。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">MyBlog</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Core\CoreService</span>;</span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">BlogService</span> <span class="pl-k">extends</span> <span class="pl-e">CoreService</span> {</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-c1">funciton</span> entry() {</span>
<span class="pl-s1">        <span class="pl-c">// $this-&gt;{ページ名}-&gt;(Modelクラスのメソッド)</span></span>
<span class="pl-s1">        <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">Blog</span><span class="pl-k">-&gt;</span>getEntryData();</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<p>Serviceクラス内の<code>$this-&gt;{ページ名}</code>オブジェクトにはModelクラスのインスタンスが格納されています。ModelクラスにアクセスしてDB処理を実行します。<br>
また、ServiceクラスにはContoller、Service、Model、Helperの各クラスに属さないユーザ定義クラスへのパスが通っています。<code>app/libraries/</code>ディレクトリに任意のクラスを定義することでServiceクラスからアクセスできます。例えば、外部APIにアクセスするクラスや、データをバインドするEntityクラスなど特定用途のクラスはlibrariesに定義してください。</p>

<p>Serviceクラスは、Viewから参照されるデータを格納する<strong>ViewModel</strong>の機能を内包しています。<br>
Viewから参照するデータはServiceクラスのGetterメソッドを経由して参照することになりますが、データ量が多くなる場合、Getterメソッドとそれに使うプロパティが増えていきます。
これらはServiceの機能とは本質的には無関係な定義であるにもかかわらず、コード量として多くなってしまうため、Serviceでは<code>PropertyProxy</code>という機能を使い、簡単にViewModelを使えるようにしています。<br>
Serviceクラスの中で、未定義のプロパティに値をセットすると、PropertyProxyにより、Serviceクラス内で値が保持されます。保持されたデータはViewから参照可能になります。
これにより、Viewから参照するデータをGetterメソッドなしで参照でき、カプセル化した状態で値を保持することができます。</p>

<p><strong>PropertyProxyを使わない場合</strong></p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">MyBlog</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Core\CoreService</span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-c">// PropertyProxyなしの場合、Getterメソッドが必要</span></span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">BlogService</span> <span class="pl-k">extends</span> <span class="pl-e">CoreService</span> {</span>
<span class="pl-s1">    <span class="pl-c">// プロパティはpublicにすべきではない</span></span>
<span class="pl-s1">    <span class="pl-k">private</span> <span class="pl-smi">$title</span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-k">function</span> <span class="pl-en">getTitle</span>()</span>
<span class="pl-s1">    {</span>
<span class="pl-s1">        <span class="pl-c">// ViewからはpublicなGetterメソッドでなければ参照不可</span></span>
<span class="pl-s1">        <span class="pl-k">return</span> <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">title</span>;</span>
<span class="pl-s1">    }</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-c1">funciton</span> entry() {</span>
<span class="pl-s1">        <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">title</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>マイブログ<span class="pl-pds">"</span></span>;</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<div class="highlight highlight-text-html-basic"><pre>&lt;!DOCTYPE html PUBLIC <span class="pl-s">"-//W3C//DTD XHTML 1.0 Transitional//EN"</span>
  <span class="pl-s">"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"</span>&gt;
&lt;<span class="pl-ent">html</span> <span class="pl-e">xmlns</span>=<span class="pl-s"><span class="pl-pds">"</span>http://www.w3.org/1999/xhtml<span class="pl-pds">"</span></span> <span class="pl-e">xml:lang</span>=<span class="pl-s"><span class="pl-pds">"</span>ja<span class="pl-pds">"</span></span> <span class="pl-e">lang</span>=<span class="pl-s"><span class="pl-pds">"</span>ja<span class="pl-pds">"</span></span>&gt;
    &lt;<span class="pl-ent">meta</span> <span class="pl-e">http-equiv</span>=<span class="pl-s"><span class="pl-pds">"</span>Content-Type<span class="pl-pds">"</span></span> <span class="pl-e">content</span>=<span class="pl-s"><span class="pl-pds">"</span>text/html; charset=UTF-8<span class="pl-pds">"</span></span>/&gt;
    &lt;<span class="pl-ent">head</span>&gt;
        &lt;<span class="pl-ent">title</span>&gt;%H{$model-&gt;getTitle()}&lt;/<span class="pl-ent">title</span>&gt;
    &lt;/<span class="pl-ent">head</span>&gt;
    &lt;<span class="pl-ent">body</span>&gt;
    &lt;/<span class="pl-ent">body</span>&gt;
&lt;/<span class="pl-ent">html</span>&gt;</pre></div>

<p><strong>PropertyProxyを使った場合</strong></p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">MyBlog</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Core\CoreService</span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-c">// PropertyProxy使用の場合、Getterメソッドは不要</span></span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">BlogService</span> <span class="pl-k">extends</span> <span class="pl-e">CoreService</span> {</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-c1">funciton</span> entry() {</span>
<span class="pl-s1">        <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">title</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>マイブログ<span class="pl-pds">"</span></span>;</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<div class="highlight highlight-text-html-basic"><pre>&lt;!DOCTYPE html PUBLIC <span class="pl-s">"-//W3C//DTD XHTML 1.0 Transitional//EN"</span>
  <span class="pl-s">"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"</span>&gt;
&lt;<span class="pl-ent">html</span> <span class="pl-e">xmlns</span>=<span class="pl-s"><span class="pl-pds">"</span>http://www.w3.org/1999/xhtml<span class="pl-pds">"</span></span> <span class="pl-e">xml:lang</span>=<span class="pl-s"><span class="pl-pds">"</span>ja<span class="pl-pds">"</span></span> <span class="pl-e">lang</span>=<span class="pl-s"><span class="pl-pds">"</span>ja<span class="pl-pds">"</span></span>&gt;
    &lt;<span class="pl-ent">meta</span> <span class="pl-e">http-equiv</span>=<span class="pl-s"><span class="pl-pds">"</span>Content-Type<span class="pl-pds">"</span></span> <span class="pl-e">content</span>=<span class="pl-s"><span class="pl-pds">"</span>text/html; charset=UTF-8<span class="pl-pds">"</span></span>/&gt;
    &lt;<span class="pl-ent">head</span>&gt;
        &lt;<span class="pl-ent">title</span>&gt;%H{$model-&gt;title}&lt;/<span class="pl-ent">title</span>&gt;
    &lt;/<span class="pl-ent">head</span>&gt;
    &lt;<span class="pl-ent">body</span>&gt;
    &lt;/<span class="pl-ent">body</span>&gt;
&lt;/<span class="pl-ent">html</span>&gt;</pre></div>

<p>なお、定義済みのプロパティにセットした場合は、PropertyProxyは使われません。<br>
また、この機能はModelでも有効ですが、Serviceクラスを作る必要のない簡単な処理の場合以外はServiceクラスのViewModel機能を使うことを推奨します。</p>

<h2>
<a id="model" class="anchor" href="#model" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="#model">Model</a>
</h2>

<p>ModelクラスはControllerクラス、ServiceクラスまたはViewクラスからのリクエストや受け取ったデータを元にデータベースに問い合わせます。<br>
Serviceクラスが定義されない場合はController、Viewから直接呼び出されます。Modelにはデータベース問い合わせ処理を記述します。<br>
<code>app/models</code>に<code>WebStream\Core\CoreModel</code>クラスを継承したクラスを定義します。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">MyBlog</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Core\CoreModel</span>;</span>
<span class="pl-s1"><span class="pl-c">/**</span></span>
<span class="pl-s1"><span class="pl-c"> * @Inject</span></span>
<span class="pl-s1"><span class="pl-c"> * @Database(driver="WebStream\Database\Driver\Mysql", config="config/database.mysql.ini")</span></span>
<span class="pl-s1"><span class="pl-c"> */</span></span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">BlogModel</span> <span class="pl-k">extends</span> <span class="pl-e">CoreModel</span> {</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-c1">funciton</span> getEntryData() {</span>
<span class="pl-s1">        <span class="pl-smi">$sql</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-s1"><span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> T_Blog</span><span class="pl-pds">"</span></span>;</span>
<span class="pl-s1">        <span class="pl-k">return</span> <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span>select(<span class="pl-smi">$sql</span>);</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<p>外部変数をパラメータに指定するには<code>$bind</code>変数にパラメータをセットします。
<code>$bind</code>変数には連想配列でプリペアードステートメントに設定する値を指定します。
データベース接続設定はクラスに<a href="#annotaion">アノテーション</a>を指定します。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">MyBlog</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Core\CoreModel</span>;</span>
<span class="pl-s1"><span class="pl-c">/**</span></span>
<span class="pl-s1"><span class="pl-c"> * @Inject</span></span>
<span class="pl-s1"><span class="pl-c"> * @Database(driver="WebStream\Database\Driver\Mysql", config="config/database.mysql.ini")</span></span>
<span class="pl-s1"><span class="pl-c"> */</span></span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">BlogModel</span> <span class="pl-k">extends</span> <span class="pl-e">CoreModel</span> {</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-c1">funciton</span> getEntryData() {</span>
<span class="pl-s1">        <span class="pl-smi">$sql</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-s1"><span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> T_Blog <span class="pl-k">WHERE</span> id <span class="pl-k">=</span> :id</span><span class="pl-pds">"</span></span>;</span>
<span class="pl-s1">        <span class="pl-smi">$bind</span> <span class="pl-k">=</span> [<span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span> <span class="pl-k">=&gt;</span> <span class="pl-c1">10</span>];</span>
<span class="pl-s1">        <span class="pl-k">return</span> <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span>select(<span class="pl-smi">$sql</span>, <span class="pl-smi">$bind</span>);</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<p>Modelクラスでは以下のメソッドが利用可能です。</p>

<h4>
<a id="modelで利用可能なメソッド一覧" class="anchor" href="#model%E3%81%A7%E5%88%A9%E7%94%A8%E5%8F%AF%E8%83%BD%E3%81%AA%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E4%B8%80%E8%A6%A7" aria-hidden="true"><span class="octicon octicon-link"></span></a>Modelで利用可能なメソッド一覧</h4>

<table>
<thead>
<tr>
<th>メソッド</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>select(string $sql)<br>select(string $sql, array $bind)</td>
<td>SELECTを実行する。</td>
</tr>
<tr>
<td>insert(string $sql, array $bind)</td>
<td>INSERTを実行する。</td>
</tr>
<tr>
<td>update(string $sql, array $bind)</td>
<td>UPDATEを実行する。</td>
</tr>
<tr>
<td>delete(string $sql)<br>delete(string $sql, array $bind)</td>
<td>DELETEを実行する。</td>
</tr>
<tr>
<td>beginTransation()</td>
<td>トランザクションを開始する。</td>
</tr>
<tr>
<td>commit()</td>
<td>コミットする。</td>
</tr>
<tr>
<td>rollback()</td>
<td>ロールバックする。</td>
</tr>
<tr>
<td>connect()</td>
<td>DBに接続する。</td>
</tr>
<tr>
<td>disconnect()</td>
<td>DBを切断する。</td>
</tr>
</tbody>
</table>

<h4>
<a id="クエリファイルによるsql実行" class="anchor" href="#%E3%82%AF%E3%82%A8%E3%83%AA%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AB%E3%82%88%E3%82%8Bsql%E5%AE%9F%E8%A1%8C" aria-hidden="true"><span class="octicon octicon-link"></span></a>クエリファイルによるSQL実行</h4>

<p>Modelクラスでは直接SQLをメソッド内に記述する以外に、クエリファイル(XML)を使ってSQLを実行できます。クエリファイルは<code>query/</code>に保存します。</p>

<div class="highlight highlight-text-xml"><pre>&lt;?<span class="pl-ent">xml</span><span class="pl-e"> version</span>=<span class="pl-s"><span class="pl-pds">"</span>1.0<span class="pl-pds">"</span></span><span class="pl-e"> encoding</span>=<span class="pl-s"><span class="pl-pds">"</span>utf-8<span class="pl-pds">"</span></span>?&gt;
&lt;!<span class="pl-k">DOCTYPE</span> <span class="pl-v">mapper</span> PUBLIC
  "-//github.com/mapserver2007//DTD Mapper 3.0//EN" "http://localhost/webstream-model-mapper.dtd"&gt;
&lt;<span class="pl-ent">mapper</span> <span class="pl-e">namespace</span>=<span class="pl-s"><span class="pl-pds">"</span>MyBlog<span class="pl-pds">"</span></span>&gt;
  &lt;<span class="pl-ent">select</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">"</span>getData<span class="pl-pds">"</span></span>&gt;
    SELECT
        *
    FROM
        T_Blog
    WHERE
        id = :id
  &lt;/<span class="pl-ent">select</span>&gt;
&lt;/<span class="pl-ent">mapper</span>&gt;</pre></div>

<p>クエリファイルのDTDは同ディレクトリに配置し、DOCTYPEの値は適宜修正しDTDを指すようにします。<br>
mapperタグの<code>namespace</code>にModelクラスの名前空間を指定します。名前空間が一致すればModelクラスからクエリファイルを呼び出すことができます。<br>
mapperタグ配下にSQLを記述するタグを記述します。<code>&lt;select&gt;</code>、<code>&lt;insert&gt;</code>、<code>&lt;update&gt;</code>、<code>&lt;delete&gt;</code>タグが指定可能です。タグの<code>id</code>をModelクラスのメソッドからアクセスするとSQLを実行できます。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">MyBlog</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Core\CoreModel</span>;</span>
<span class="pl-s1"><span class="pl-c">/**</span></span>
<span class="pl-s1"><span class="pl-c"> * @Inject</span></span>
<span class="pl-s1"><span class="pl-c"> * @Database(driver="WebStream\Database\Driver\Mysql", config="config/database.mysql.ini")</span></span>
<span class="pl-s1"><span class="pl-c"> */</span></span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">BlogModel</span> <span class="pl-k">extends</span> <span class="pl-e">CoreModel</span> {</span>
<span class="pl-s1">    <span class="pl-c">/**</span></span>
<span class="pl-s1"><span class="pl-c">     * @Inject</span></span>
<span class="pl-s1"><span class="pl-c">     * @Query(file="query/myblog.xml")</span></span>
<span class="pl-s1"><span class="pl-c">     */</span></span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-c1">funciton</span> getEntryData() {</span>
<span class="pl-s1">        <span class="pl-smi">$bind</span> <span class="pl-k">=</span> [<span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span> <span class="pl-k">=&gt;</span> <span class="pl-c1">10</span>];</span>
<span class="pl-s1">        <span class="pl-k">return</span> <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span>getData(<span class="pl-smi">$bind</span>);</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<h4>
<a id="クエリファイルによるsql実行結果をエンティティクラスにマッピングする" class="anchor" href="#%E3%82%AF%E3%82%A8%E3%83%AA%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AB%E3%82%88%E3%82%8Bsql%E5%AE%9F%E8%A1%8C%E7%B5%90%E6%9E%9C%E3%82%92%E3%82%A8%E3%83%B3%E3%83%86%E3%82%A3%E3%83%86%E3%82%A3%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AB%E3%83%9E%E3%83%83%E3%83%94%E3%83%B3%E3%82%B0%E3%81%99%E3%82%8B" aria-hidden="true"><span class="octicon octicon-link"></span></a>クエリファイルによるSQL実行結果をエンティティクラスにマッピングする</h4>

<p>クエリファイルの<code>&lt;select&gt;</code>タグの<code>entity</code>属性にクラスパスを設定すると、取得結果をマッピングすることができます。<br>
Modelクラスでは直接SQLをメソッド内に記述する以外に、クエリファイル(XML)を使ってSQLを実行できます。クエリファイルは<code>query/</code>に保存します。</p>

<div class="highlight highlight-text-xml"><pre>&lt;?<span class="pl-ent">xml</span><span class="pl-e"> version</span>=<span class="pl-s"><span class="pl-pds">"</span>1.0<span class="pl-pds">"</span></span><span class="pl-e"> encoding</span>=<span class="pl-s"><span class="pl-pds">"</span>utf-8<span class="pl-pds">"</span></span>?&gt;
&lt;!<span class="pl-k">DOCTYPE</span> <span class="pl-v">mapper</span> PUBLIC
  "-//github.com/mapserver2007//DTD Mapper 3.0//EN" "http://localhost/webstream-model-mapper.dtd"&gt;
&lt;<span class="pl-ent">mapper</span> <span class="pl-e">namespace</span>=<span class="pl-s"><span class="pl-pds">"</span>MyBlog<span class="pl-pds">"</span></span>&gt;
  &lt;<span class="pl-ent">select</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">"</span>getData<span class="pl-pds">"</span></span> <span class="pl-e">entity</span>=<span class="pl-s"><span class="pl-pds">"</span>\MyBlog\Entity\BlogEntity<span class="pl-pds">"</span></span>&gt;
    SELECT
        title,
        description
    FROM
        T_Blog
  &lt;/<span class="pl-ent">select</span>&gt;
&lt;/<span class="pl-ent">mapper</span>&gt;</pre></div>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">MyBlog\Entity</span>;</span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">BlogEntity</span> {</span>
<span class="pl-s1">    <span class="pl-k">private</span> <span class="pl-smi">$title</span>;</span>
<span class="pl-s1">    <span class="pl-k">private</span> <span class="pl-smi">$description</span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-c1">funciton</span> getTitle() {</span>
<span class="pl-s1">        <span class="pl-k">return</span> <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">title</span>;</span>
<span class="pl-s1">    }</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-c1">funciton</span> getDescription() {</span>
<span class="pl-s1">        <span class="pl-k">return</span> <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">description</span>;</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<p>テーブルのカラム名とエンティティクラスのフィールド名には対応関係があり、それにしたがってマッピング定義する必要があります。<br>
エンティティクラスのフィールド名はローワーキャメルケースで定義すると、型を含めてマッピングが実行されます。<br>
テーブルのカラム名がスネークケースである場合、自動的に名前をローワーキャメルケースに変換した上でマッピングされます。カラム名がエンティティクラスのフィールド名にマッピングできない命名になっている場合、SQLのAS句で別名を付けて対応してください。</p>

<h4>
<a id="取得結果を配列にする" class="anchor" href="#%E5%8F%96%E5%BE%97%E7%B5%90%E6%9E%9C%E3%82%92%E9%85%8D%E5%88%97%E3%81%AB%E3%81%99%E3%82%8B" aria-hidden="true"><span class="octicon octicon-link"></span></a>取得結果を配列にする</h4>

<p><code>select</code>で取得した結果を配列に変換します。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$this</span><span class="pl-k">-&gt;</span>select(<span class="pl-smi">$sql</span>, <span class="pl-smi">$bind</span>)<span class="pl-k">-&gt;</span>toArray();</span></pre></div>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$this</span><span class="pl-k">-&gt;</span>getData(<span class="pl-smi">$bind</span>)<span class="pl-k">-&gt;</span>toArray();</span></pre></div>

<h4>
<a id="取得結果をエンティティにする" class="anchor" href="#%E5%8F%96%E5%BE%97%E7%B5%90%E6%9E%9C%E3%82%92%E3%82%A8%E3%83%B3%E3%83%86%E3%82%A3%E3%83%86%E3%82%A3%E3%81%AB%E3%81%99%E3%82%8B" aria-hidden="true"><span class="octicon octicon-link"></span></a>取得結果をエンティティにする</h4>

<p><code>select</code>で取得した結果をエンティティに変換します。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$entityClasspath</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>\MyBlog\Entity\BlogEntity<span class="pl-pds">"</span></span>;</span>
<span class="pl-s1"><span class="pl-smi">$this</span><span class="pl-k">-&gt;</span>select(<span class="pl-smi">$sql</span>, <span class="pl-smi">$bind</span>)<span class="pl-k">-&gt;</span>toEntity(<span class="pl-smi">$entityClasspath</span>);</span></pre></div>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$entityClasspath</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>\MyBlog\Entity\BlogEntity<span class="pl-pds">"</span></span>;</span>
<span class="pl-s1"><span class="pl-smi">$this</span><span class="pl-k">-&gt;</span>getData(<span class="pl-smi">$bind</span>)<span class="pl-k">-&gt;</span>toEntity(<span class="pl-smi">$entityClasspath</span>);</span></pre></div>

<p><a href="#annotaion">アノテーション</a>を使い、クエリファイルパスを指定します。これによりクエリファイルに記述したSQLが自動的に紐付けられます。</p>

<h4>
<a id="トランザクション処理" class="anchor" href="#%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E5%87%A6%E7%90%86" aria-hidden="true"><span class="octicon octicon-link"></span></a>トランザクション処理</h4>

<p><code>$this-&gt;beginTransation()</code>でトランザクションを開始し<code>$this-&gt;commit()</code>でコミット、<code>$this-&gt;rollback()</code>でロールバックを実行します。<br>
ただし、DBMSがトランザクション処理に対応していない場合はトランザクション処理は有効になりません。<br>
なお、トランザクション処理を明示しない場合、処理が終了後、自動的にコミットを実行します。</p>

<h2>
<a id="view" class="anchor" href="#view" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="#view">View</a>
</h2>

<p>Viewは画面に出力するHTMLなどを描画し、Controllerクラスから呼ばれます。HTML等の描画はWebStream独自のテンプレート機能を利用します。<br>
ViewからはHelperまたはModel、Serviceを呼び出してビジネスロジックを実行することができます。</p>

<p>ViewテンプレートはWebStream独自のBasicテンプレートとTwigテンプレートが使えます。
Baicテンプレートファイルは<code>.tmpl</code>拡張子を、Twigテンプレートは<code>.twig</code>を付け、<code>app/views</code>にページ名をスネークケースに変換したフォルダを作成し保存します。<br>
<code>__cache</code>、<code>__public</code>、<code>__shared</code>フォルダを作成すると、それぞれテンプレートキャッシュファイル、静的ファイル、共通テンプレートファイルを使用することができます。<br>
ViewにはModel/Serviceオブジェクトが渡されるので、Model、Serviceで取得した値やビジネスロジックの実行がViewで可能になります。<br>
Model/Serviceオブジェクトは<code>$model</code>変数に格納されます。また、Helperオブジェクトは<code>$helper</code>変数に格納されます。</p>

<p>ContollerクラスからViewテンプレートを呼び出します。<code>@Template</code>の仕様は<a href="#annotaion">アノテーション</a>を参照してください。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">MyBlog</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Core\CoreController</span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-c">/**</span></span>
<span class="pl-s1"><span class="pl-c"> * テンプレートを呼び出す。</span></span>
<span class="pl-s1"><span class="pl-c"> * @Inject</span></span>
<span class="pl-s1"><span class="pl-c"> * @Template("index.tmpl")</span></span>
<span class="pl-s1"><span class="pl-c"> */</span></span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">BlogController</span> <span class="pl-k">extends</span> <span class="pl-e">CoreController</span> {</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-c1">funciton</span> execute() {</span>
<span class="pl-s1">        <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">Blog</span><span class="pl-k">-&gt;</span>entry();</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<p><code>__shared</code>に保存した共通テンプレートを呼び出すことができます。<br>
共通点プレートはheaderやfooterなど共通になる部分を定義するときに使用します。  </p>

<p>テンプレートを部品化したい場合、部分テンプレートとして呼び出すことができます。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">MyBlog</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Core\CoreController</span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-c">/**</span></span>
<span class="pl-s1"><span class="pl-c"> * 基本テンプレートと共通テンプレートを呼び出す。</span></span>
<span class="pl-s1"><span class="pl-c"> * @Inject</span></span>
<span class="pl-s1"><span class="pl-c"> * @Template("index.tmpl")</span></span>
<span class="pl-s1"><span class="pl-c"> */</span></span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">BlogController</span> <span class="pl-k">extends</span> <span class="pl-e">CoreController</span> {</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-c1">funciton</span> execute() {</span>
<span class="pl-s1">        <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">Blog</span><span class="pl-k">-&gt;</span>entry();</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<p>ViewテンプレートにはHTMLを記述しますが、Service/Modelの値などを埋め込むことができます。</p>

<div class="highlight highlight-text-html-basic"><pre>&lt;!DOCTYPE html PUBLIC <span class="pl-s">"-//W3C//DTD XHTML 1.0 Transitional//EN"</span>
  <span class="pl-s">"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"</span>&gt;
&lt;<span class="pl-ent">html</span> <span class="pl-e">xmlns</span>=<span class="pl-s"><span class="pl-pds">"</span>http://www.w3.org/1999/xhtml<span class="pl-pds">"</span></span> <span class="pl-e">xml:lang</span>=<span class="pl-s"><span class="pl-pds">"</span>ja<span class="pl-pds">"</span></span> <span class="pl-e">lang</span>=<span class="pl-s"><span class="pl-pds">"</span>ja<span class="pl-pds">"</span></span>&gt;
    &lt;<span class="pl-ent">meta</span> <span class="pl-e">http-equiv</span>=<span class="pl-s"><span class="pl-pds">"</span>Content-Type<span class="pl-pds">"</span></span> <span class="pl-e">content</span>=<span class="pl-s"><span class="pl-pds">"</span>text/html; charset=UTF-8<span class="pl-pds">"</span></span>/&gt;
    &lt;<span class="pl-ent">head</span>&gt;
        &lt;<span class="pl-ent">title</span>&gt;%H{$model-&gt;getTitle()}&lt;/<span class="pl-ent">title</span>&gt;
    &lt;/<span class="pl-ent">head</span>&gt;
    &lt;<span class="pl-ent">body</span>&gt;
        &lt;<span class="pl-ent">div</span>&gt;%H{$model-&gt;getContent()}&lt;/<span class="pl-ent">div</span>&gt;
        %T{parts.tmpl}
    &lt;/<span class="pl-ent">body</span>&gt;
&lt;/<span class="pl-ent">html</span>&gt;</pre></div>

<p><code>$model</code>にアクセスするとServiceクラスまたはModelクラスにアクセスできます。また、<code>@Template</code>の<code>name</code>属性に指定した名前は変数としてアクセスできます。</p>

<p>使用するテンプレートエンジンを明示する場合は以下のようにします。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">MyBlog</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Core\CoreController</span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-c">/**</span></span>
<span class="pl-s1"><span class="pl-c"> * Basicテンプレートを使用する</span></span>
<span class="pl-s1"><span class="pl-c"> * @Inject</span></span>
<span class="pl-s1"><span class="pl-c"> * @Template("index.tmpl", engine="basic")</span></span>
<span class="pl-s1"><span class="pl-c"> */</span></span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">BlogController</span> <span class="pl-k">extends</span> <span class="pl-e">CoreController</span> {</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-c1">funciton</span> execute() {</span>
<span class="pl-s1">        <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">Blog</span><span class="pl-k">-&gt;</span>entry();</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">MyBlog</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Core\CoreController</span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-c">/**</span></span>
<span class="pl-s1"><span class="pl-c"> * Twigテンプレートを使用する</span></span>
<span class="pl-s1"><span class="pl-c"> * @Inject</span></span>
<span class="pl-s1"><span class="pl-c"> * @Template("index.tmpl", engine="twig")</span></span>
<span class="pl-s1"><span class="pl-c"> */</span></span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">BlogController</span> <span class="pl-k">extends</span> <span class="pl-e">CoreController</span> {</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-c1">funciton</span> execute() {</span>
<span class="pl-s1">        <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">Blog</span><span class="pl-k">-&gt;</span>entry();</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<p>Basicテンプレートにはテンプレートキャッシュ機能とCSRF対策トークン自動挿入機能がつきます。この機能により、CSRF対策が自動的に有効になります。<br>
Basicテンプレートを指定している場合に<code>&lt;form&gt;</code>タグが含まれる場合、CSRF対策トークンが自動挿入されます。<br>
(ただし、method="get"の場合は有効になりません。)</p>

<div class="highlight highlight-text-html-basic"><pre>&lt;<span class="pl-ent">head</span>&gt;
&lt;<span class="pl-ent">meta</span> <span class="pl-e">charset</span>=<span class="pl-s"><span class="pl-pds">"</span>utf-8<span class="pl-pds">"</span></span>&gt;
&lt;<span class="pl-ent">title</span>&gt;CSRF CHECK&lt;/<span class="pl-ent">title</span>&gt;
&lt;/<span class="pl-ent">head</span>&gt;
&lt;<span class="pl-ent">body</span>&gt;
&lt;<span class="pl-ent">form</span> <span class="pl-e">action</span>=<span class="pl-s"><span class="pl-pds">"</span>/form_register<span class="pl-pds">"</span></span> <span class="pl-e">method</span>=<span class="pl-s"><span class="pl-pds">"</span>post<span class="pl-pds">"</span></span>&gt;
    &lt;<span class="pl-ent">input</span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>button<span class="pl-pds">"</span></span> <span class="pl-e">value</span>=<span class="pl-s"><span class="pl-pds">"</span>submit<span class="pl-pds">"</span></span>&gt;
    &lt;<span class="pl-ent">input</span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>hidden<span class="pl-pds">"</span></span> <span class="pl-e">name</span>=<span class="pl-s"><span class="pl-pds">"</span>__CSRF_TOKEN__<span class="pl-pds">"</span></span> <span class="pl-e">value</span>=<span class="pl-s"><span class="pl-pds">"</span>a2891f68edeb487a9140edf8575a8e3382f96c0d<span class="pl-pds">"</span></span>&gt;
&lt;/<span class="pl-ent">form</span>&gt;
&lt;/<span class="pl-ent">body</span>&gt;</pre></div>

<p>フォームの送り先のControllerクラスで<code>@CsrfProtection</code>アノテーションを指定すると、CSRFチェック処理が実行されます。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">MyBlog</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Core\CoreController</span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">BlogController</span> <span class="pl-k">extends</span> <span class="pl-e">CoreController</span> {</span>
<span class="pl-s1">    <span class="pl-c">/**</span></span>
<span class="pl-s1"><span class="pl-c">     * @Inject</span></span>
<span class="pl-s1"><span class="pl-c">     * @CsrfProtection</span></span>
<span class="pl-s1"><span class="pl-c">     */</span></span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-c1">funciton</span> formRegister() {</span>
<span class="pl-s1">        <span class="pl-c">// CSRFエラーがあった場合、例外が発生し、ここには到達しない</span></span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<p>CSRF対策トークンの送信はPOSTで通常行いますが、HTTPヘッダ<code>X-CSRF-Token</code>にトークン文字列を指定して送信することも可能です。</p>

<p>テンプレートキャッシュ機能は、出力した内容をまるごとキャッシュする機能で、<code>cacheTime</code>属性で指定した時間(秒)だけキャッシュします。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">MyBlog</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Core\CoreController</span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">BlogController</span> <span class="pl-k">extends</span> <span class="pl-e">CoreController</span> {</span>
<span class="pl-s1">    <span class="pl-c">/**</span></span>
<span class="pl-s1"><span class="pl-c">     * テンプレートキャッシュを600秒有効にする例</span></span>
<span class="pl-s1"><span class="pl-c">     * @Inject</span></span>
<span class="pl-s1"><span class="pl-c">     * @Template("index.tmpl", engine="basic", cacheTime=600)</span></span>
<span class="pl-s1"><span class="pl-c">     */</span></span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-c1">funciton</span> execute() {</span>
<span class="pl-s1">        <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">Blog</span><span class="pl-k">-&gt;</span>entry();</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<p>Viewテンプレートでは以下の構文が使用可能です。</p>

<h3>
<a id="viewテンプレート構文" class="anchor" href="#view%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E6%A7%8B%E6%96%87" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="#template_keyword">Viewテンプレート構文</a>
</h3>

<table>
<thead>
<tr>
<th>構文</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>%P{$hoge}</td>
<td>%P{}で囲ったPHPのコードを実行する。関数を実行する場合などに使用する。<br>ただし、関数の実行結果をreturnしても画面表示されない。また、関数内部で<code>echo</code>で標準出力した場合はエスケープされないので注意。<br>実行結果を伴わない関数の実行が必要な場合に使用する。</td>
</tr>
<tr>
<td>%H{$hoge}</td>
<td>%H{}で囲った変数を安全な値にエスケープしてHTMLとして表示する。関数を実行する場合も使用可能で、returnで返却された結果をエスケープして画面表示する。<br>ただし、関数内部で<code>echo</code>で標準出力した場合はエスケープされないので注意。</td>
</tr>
<tr>
<td>%J{$hoge}</td>
<td>%J{}で囲った変数を安全な値にエスケープしてJavaScriptコードとして評価する。関数を実行する場合も使用可能で、returnで返却された結果をエスケープして画面表示する。<br>ただし、関数内部で<code>echo</code>で標準出力した場合はエスケープされないので注意。</td>
</tr>
<tr>
<td>%X{$hoge}</td>
<td>%X{}で囲った変数を安全な値にエスケープしてXMLとして評価する。関数を実行する場合も使用可能で、returnで返却された結果をエスケープして画面表示する。<br>ただし、関数内部で<code>echo</code>で標準出力した場合はエスケープされないので注意。</td>
</tr>
<tr>
<td>%T{$template}</td>
<td>%T{}で囲ったテンプレートパスを読み込む。</td>
</tr>
</tbody>
</table>

<h2>
<a id="helper" class="anchor" href="#helper" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="#helper">Helper</a>
</h2>

<p>Viewの描画に関するロジックが必要な場合はHelperを呼び出します。<br>
Helperクラスは<code>app/helpers</code>に<code>WebStream\Core\CoreHelper</code>クラスを継承したクラスを定義します。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">WebStream\Test\TestData\Sample\App\Helper</span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Core\CoreHelper</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Core\CoreService</span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">TestHelperHelper</span> <span class="pl-k">extends</span> <span class="pl-e">CoreHelper</span></span>
<span class="pl-s1">{</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-k">function</span> <span class="pl-en">help1</span>()</span>
<span class="pl-s1">    {</span>
<span class="pl-s1">         <span class="pl-k">return</span> <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span>help2(<span class="pl-smi">$model</span><span class="pl-k">-&gt;</span>getName());</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<p>Helperクラス内ではViewテンプレート内と同様に<code>$model</code>オブジェクトからModelクラス、Serviceクラスを呼び出すことができます。<br>
Helperクラスのメソッドは<code>$helper</code>オブジェクトにより呼び出します。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$helper</span><span class="pl-k">-&gt;</span>method();</span></pre></div>

<p>メソッド呼び出しにより、Viewテンプレートで必要なロジックを実行します。<br>
メソッドの戻り値はViewテンプレートに描画されますが、<a href="#template_keyword">Viewテンプレート構文</a>によりエスケープして出力し、安全な値として出力する必要があります。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">%</span><span class="pl-c1">H</span>{<span class="pl-smi">$helper</span><span class="pl-k">-&gt;</span>method()}</span></pre></div>

<p>ただし、Helper内で直接echoで出力するとエスケープされないので注意してください。</p>

<h2>
<a id="命名規則まとめ" class="anchor" href="#%E5%91%BD%E5%90%8D%E8%A6%8F%E5%89%87%E3%81%BE%E3%81%A8%E3%82%81" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="#naming_rule">命名規則まとめ</a>
</h2>

<p>各クラスの命名規則、保存場所のまとめは以下のとおりです。</p>

<table>
<thead>
<tr>
<th>レイヤ</th>
<th>サンプルクラス名</th>
<th>保存場所</th>
</tr>
</thead>
<tbody>
<tr>
<td>Controller</td>
<td>SampleController</td>
<td>app/controllers/SampleController.php</td>
</tr>
<tr>
<td>Service</td>
<td>SampleService</td>
<td>app/services/SampleService.php</td>
</tr>
<tr>
<td>Model</td>
<td>SampleModel</td>
<td>app/models/SampleModel.php</td>
</tr>
<tr>
<td>View</td>
<td>(任意の名前).tmpl</td>
<td>app/views/sample/(任意の名前).tmpl</td>
</tr>
<tr>
<td>Helper</td>
<td>SampleHelper</td>
<td>app/helpers/SampleHelper.php</td>
</tr>
</tbody>
</table>

<p>上記レイヤに乗らない、開発者が独自に定義したいクラスを格納する階層を作成することができます。</p>

<table>
<thead>
<tr>
<th>レイヤ</th>
<th>サンプルクラス名</th>
<th>保存場所</th>
</tr>
</thead>
<tbody>
<tr>
<td>独自レイヤ</td>
<td>(任意の名前)</td>
<td>app/(任意の場所)/(任意の名前).php</td>
</tr>
</tbody>
</table>

<p>エンティティマッピングで使用するエンティティクラスや外部APIを利用するためのクラスなどはここに定義します。</p>

<h2>
<a id="ルーティング定義" class="anchor" href="#%E3%83%AB%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E5%AE%9A%E7%BE%A9" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="#routing">ルーティング定義</a>
</h2>

<h3>
<a id="routesphp" class="anchor" href="#routesphp" aria-hidden="true"><span class="octicon octicon-link"></span></a>routes.php</h3>

<p>ルーティング設定により、URI設計を行うことができます。ルーティングにはmod_rewiteが必要です。<br>
ルーティング定義は<code>config/routes.php</code>に記述します。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">WebStream\Router</span>;</span>
<span class="pl-s1"><span class="pl-c1">Router</span><span class="pl-k">::</span>setRule([</span>
<span class="pl-s1">    <span class="pl-s"><span class="pl-pds">'</span>/login<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>sample#login<span class="pl-pds">'</span></span></span>
<span class="pl-s1">    <span class="pl-s"><span class="pl-pds">'</span>/blog/:id<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>blog#entry<span class="pl-pds">'</span></span></span>
<span class="pl-s1">]);</span></pre></div>

<p>ルーティングルールは配列で定義し、キーにURIパス定義、バリューにクラス、アクション定義を記述します。誤った定義が記述された場合、例外が発生します。</p>

<h3>
<a id="uriパス定義" class="anchor" href="#uri%E3%83%91%E3%82%B9%E5%AE%9A%E7%BE%A9" aria-hidden="true"><span class="octicon octicon-link"></span></a>URIパス定義</h3>

<p>URIパスは<code>/path/to</code>形式で定義します。またURIには変数の設定が可能で、<code>:value</code>形式で記述します。例えば、<code>/blog/:id</code>と定義し、<code>/blog/10</code>にアクセスした場合、Controllerクラスでは以下の方法で値を取得出来ます。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">MyBlog</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Core\CoreController</span>;</span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">BlogController</span> <span class="pl-k">extends</span> <span class="pl-e">CoreController</span> {</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-k">function</span> <span class="pl-en">execute</span>(<span class="pl-k">array</span> <span class="pl-smi">$params</span>) {</span>
<span class="pl-s1">        <span class="pl-smi">$id</span> <span class="pl-k">=</span> <span class="pl-smi">$params</span>[<span class="pl-s"><span class="pl-pds">'</span>id<span class="pl-pds">'</span></span>]; <span class="pl-c">// 10</span></span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<h2>
<a id="バリデーション定義" class="anchor" href="#%E3%83%90%E3%83%AA%E3%83%87%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%AE%9A%E7%BE%A9" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="#validate">バリデーション定義</a>
</h2>

<p>Controllerクラスのアクションメソッドに<code>@Validate</code>アノテーションを記述することでバリデーションを有効にできます。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">MyBlog</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Core\CoreController</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebSteram\Annotation\Validate</span>;</span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">BlogController</span> <span class="pl-k">extends</span> <span class="pl-e">CoreController</span> {</span>
<span class="pl-s1">    <span class="pl-c">/**</span></span>
<span class="pl-s1"><span class="pl-c">     * GETリクエストのtestパラメータの指定がない場合、エラーになる例</span></span>
<span class="pl-s1"><span class="pl-c">     * @Inject</span></span>
<span class="pl-s1"><span class="pl-c">     * @Validate(key="test", rule="required", method="get")</span></span>
<span class="pl-s1"><span class="pl-c">     */</span></span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-k">function</span> <span class="pl-en">execute</span>() {</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<p>バリデーションルールは以下のものが用意されています。</p>

<h4>
<a id="バリデーションチェックルール" class="anchor" href="#%E3%83%90%E3%83%AA%E3%83%87%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%83%AB%E3%83%BC%E3%83%AB" aria-hidden="true"><span class="octicon octicon-link"></span></a>バリデーションチェックルール</h4>

<table>
<thead>
<tr>
<th>ルール</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>required</td>
<td>必須チェック</td>
</tr>
<tr>
<td>number</td>
<td>数値チェック(整数)</td>
</tr>
<tr>
<td>min[n]</td>
<td>最小値チェック(整数)</td>
</tr>
<tr>
<td>max[n]</td>
<td>最大値チェック(整数)</td>
</tr>
<tr>
<td>min_length[n]</td>
<td>最小文字数チェック(整数)</td>
</tr>
<tr>
<td>max_length[n]</td>
<td>最大文字数チェック(整数)</td>
</tr>
<tr>
<td>equal</td>
<td>文字列一致チェック</td>
</tr>
<tr>
<td>length</td>
<td>文字数一致チェック</td>
</tr>
<tr>
<td>range[n..m]</td>
<td>範囲チェック(整数)</td>
</tr>
<tr>
<td>regexp[//]</td>
<td>正規表現チェック</td>
</tr>
</tbody>
</table>

<h3>
<a id="カスタムバリデーション" class="anchor" href="#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%83%90%E3%83%AA%E3%83%87%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3" aria-hidden="true"><span class="octicon octicon-link"></span></a>カスタムバリデーション</h3>

<p>用意されているバリデーションルール以外に、開発者が独自にルールを定義することが出来ます。<br>
<code>app</code>ディレクトリ配下の任意の場所にバリデーションクラスを作成します。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-pse">&lt;?php</span><span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">Blog</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Validate\Rule\IValidate</span>;</span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">Page</span> <span class="pl-k">implements</span> <span class="pl-e">IValidate</span></span>
<span class="pl-s1">{</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-k">function</span> <span class="pl-en">isValid</span>(<span class="pl-smi">$value</span>, <span class="pl-smi">$rule</span>)</span>
<span class="pl-s1">    {</span>
<span class="pl-s1">        <span class="pl-k">return</span> <span class="pl-smi">$value</span> <span class="pl-k">===</span> <span class="pl-c1">null</span> <span class="pl-k">||</span> (<span class="pl-k">bool</span>) <span class="pl-c1">preg_match</span>(<span class="pl-sr"><span class="pl-pds">'/</span><span class="pl-k">^</span><span class="pl-pds">[1-9]</span>{1,}<span class="pl-pds">[0-9]</span>{0,}<span class="pl-k">$</span><span class="pl-pds">/'</span></span>, <span class="pl-smi">$value</span>);</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<p><code>WebStream\Validate\Rule\IValidate</code>インタフェースを実装し、戻り値が<code>bool</code>型の<code>isValid</code>メソッドを実装します。<br>
バリデーションが成功すればtrue、失敗すればfalseを返すようにします。<br>
クラス名がルール名と紐付いているので、<code>@Validate</code>アノテーションに指定します。<br>
ただし、ルール名はクラス名をスネークケースに変換したものになります。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">MyBlog</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Core\CoreController</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebSteram\Annotation\Validate</span>;</span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">BlogController</span> <span class="pl-k">extends</span> <span class="pl-e">CoreController</span> {</span>
<span class="pl-s1">    <span class="pl-c">/**</span></span>
<span class="pl-s1"><span class="pl-c">     * @Inject</span></span>
<span class="pl-s1"><span class="pl-c">     * @Validate(key="p", rule="page", method="get")</span></span>
<span class="pl-s1"><span class="pl-c">     */</span></span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-k">function</span> <span class="pl-en">execute</span>() {</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<h2>
<a id="リクエストパラメータ" class="anchor" href="#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="#request">リクエストパラメータ</a>
</h2>

<p>GET/POST/PUT/DELETEで送信した値をControllerで取得できます。<br>
<code>$this-&gt;request</code>オブジェクトからリクエストパラメータを取得でき、<code>get</code>,<code>post</code>,<code>put</code>,<code>delete</code>メソッドにそれぞれアクセスします。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">MyBlog</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Core\CoreController</span>;</span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">BlogController</span> <span class="pl-k">extends</span> <span class="pl-e">CoreController</span> {</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-k">function</span> <span class="pl-en">execute</span>() {</span>
<span class="pl-s1">        <span class="pl-smi">$getParams</span> <span class="pl-k">=</span> <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">request</span><span class="pl-k">-&gt;</span>get(); <span class="pl-c">// GETパラメータすべて取得</span></span>
<span class="pl-s1">        <span class="pl-smi">$getParam</span>  <span class="pl-k">=</span> <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">request</span><span class="pl-k">-&gt;</span>get(<span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>);</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<h2>
<a id="セッション" class="anchor" href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="#session">セッション</a>
</h2>

<p>ログイン処理などを実装するときに、セッション管理を使用しますが、WebStreamでは<code>$this-&gt;session</code>オブジェクトを使用します。セッション期限を指定するには<code>restart</code>メソッドを使用します。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">MyBlog</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Core\CoreController</span>;</span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">LoginController</span> <span class="pl-k">extends</span> <span class="pl-e">CoreController</span> {</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-k">function</span> <span class="pl-en">execute</span>() {</span>
<span class="pl-s1">        <span class="pl-smi">$expire</span> <span class="pl-k">=</span> <span class="pl-c1">6000</span>; <span class="pl-c">// 10分</span></span>
<span class="pl-s1">        <span class="pl-smi">$path</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>/login<span class="pl-pds">"</span></span>;</span>
<span class="pl-s1">        <span class="pl-smi">$domain</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>.mydomain.com<span class="pl-pds">"</span></span>;</span>
<span class="pl-s1">        <span class="pl-smi">$getParams</span> <span class="pl-k">=</span> <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">session</span><span class="pl-k">-&gt;</span>restart(<span class="pl-smi">$expire</span>, <span class="pl-smi">$path</span>, <span class="pl-smi">$domain</span>);</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<p>セッションがタイムアウトした場合、<code>SessionTimeoutException</code>が発生します。</p>

<h2>
<a id="ロギング" class="anchor" href="#%E3%83%AD%E3%82%AE%E3%83%B3%E3%82%B0" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="#logging">ロギング</a>
</h2>

<p>Controller、Service、Model、Helperクラスではロガーを使用できます。  </p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">namespace</span> <span class="pl-en">MyBlog</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">WebStream\Core\CoreController</span>;</span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">LoginController</span> <span class="pl-k">extends</span> <span class="pl-e">CoreController</span> {</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-k">function</span> <span class="pl-en">index</span>() {</span>
<span class="pl-s1">        <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">logger</span><span class="pl-k">-&gt;</span>debug(<span class="pl-s"><span class="pl-pds">"</span>logging in controller<span class="pl-pds">"</span></span>);</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<p>ログレベルについては、<a href="https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-3-logger-interface.md">PSR-3</a>に準拠しています。</p>

<h2>
<a id="アノテーション" class="anchor" href="#%E3%82%A2%E3%83%8E%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="#annotation">アノテーション</a>
</h2>

<p>ControllerとModelではアノテーションを使ってクラスやメソッドを操作することができます。アノテーションを利用することで便利な処理が可能になります。<br>
クラスまたはメソッドに対するアノテーションは<code>@Inject</code>、プロパティに対するアノテーションは<code>@Autowired</code>の指定が必須です。</p>

<table>
<thead>
<tr>
<th>アノテーション</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/Inject" class="user-mention">@Inject</a></td>
<td>メソッドに対するアノテーションを有効にする</td>
</tr>
</tbody>
</table>

<h4>
<a id="すべてのレイヤで使用可能なアノテーション" class="anchor" href="#%E3%81%99%E3%81%B9%E3%81%A6%E3%81%AE%E3%83%AC%E3%82%A4%E3%83%A4%E3%81%A7%E4%BD%BF%E7%94%A8%E5%8F%AF%E8%83%BD%E3%81%AA%E3%82%A2%E3%83%8E%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3" aria-hidden="true"><span class="octicon octicon-link"></span></a>すべてのレイヤで使用可能なアノテーション</h4>

<table>
<thead>
<tr>
<th>アノテーション</th>
<th>説明</th>
<th>サンプル</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/Autowired" class="user-mention">@Autowired</a></td>
<td>プロパティに対するアノテーションを有効にする</td>
<td>
<a href="https://github.com/Autowired" class="user-mention">@Autowired</a>(value="hoge")<br><a href="https://github.com/Autowired" class="user-mention">@Autowired</a>(type="\Hoge")</td>
</tr>
<tr>
<td><a href="https://github.com/Filter" class="user-mention">@Filter</a></td>
<td>メソッドが呼ばれる前または後に任意の処理を実行する</td>
<td>
<a href="https://github.com/Filter" class="user-mention">@Filter</a>(type="before")<br><a href="https://github.com/Filter" class="user-mention">@Filter</a>(type="after")<br><a href="https://github.com/Filter" class="user-mention">@Filter</a>(type="before" except="method1")<br><a href="https://github.com/Filter" class="user-mention">@Filter</a>(type="before" only="method2")<br><a href="https://github.com/Filter" class="user-mention">@Filter</a>(type="before",only="method1",except="method2")<br><a href="https://github.com/Filter" class="user-mention">@Filter</a>(type="after",except={"method1","method2"})</td>
</tr>
</tbody>
</table>

<h4>
<a id="controllerで使用可能なアノテーション" class="anchor" href="#controller%E3%81%A7%E4%BD%BF%E7%94%A8%E5%8F%AF%E8%83%BD%E3%81%AA%E3%82%A2%E3%83%8E%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3" aria-hidden="true"><span class="octicon octicon-link"></span></a>Controllerで使用可能なアノテーション</h4>

<table>
<thead>
<tr>
<th>アノテーション</th>
<th>説明</th>
<th>サンプル</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/Header" class="user-mention">@Header</a></td>
<td>リクエスト/レスポンスを制御する</td>
<td>
<a href="https://github.com/Header" class="user-mention">@Header</a>(contentType="html")<br><a href="https://github.com/Header" class="user-mention">@Header</a>(contentType="xml")<br><a href="https://github.com/Header" class="user-mention">@Header</a>(allowMethod="POST")<br><a href="https://github.com/Header" class="user-mention">@Header</a>(allowMethod={"GET","POST"})</td>
</tr>
<tr>
<td><a href="https://github.com/Template" class="user-mention">@Template</a></td>
<td>Viewテンプレートを設定する</td>
<td>
<a href="https://github.com/Template" class="user-mention">@Template</a>("index.tmpl")<br><a href="https://github.com/Template" class="user-mention">@Template</a>("index.tmpl",name="head" type="parts")<br><a href="https://github.com/Template" class="user-mention">@Template</a>("index.tmpl",name="shared",type="shared")</td>
</tr>
<tr>
<td><a href="https://github.com/ExceptionHandler" class="user-mention">@ExceptionHandler</a></td>
<td>例外を補足して別処理を実行する</td>
<td>
<a href="https://github.com/ExceptionHandler" class="user-mention">@ExceptionHandler</a>("\Exception")<br><a href="https://github.com/ExceptionHandler" class="user-mention">@ExceptionHandler</a>({"\RuntimeException","\LogicException"})</td>
</tr>
<tr>
<td>@CsrfProtection</td>
<td>CSRF対策処理を実行する</td>
<td>@CsrfProtection</td>
</tr>
</tbody>
</table>

<h4>
<a id="modelで使用可能なアノテーション" class="anchor" href="#model%E3%81%A7%E4%BD%BF%E7%94%A8%E5%8F%AF%E8%83%BD%E3%81%AA%E3%82%A2%E3%83%8E%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3" aria-hidden="true"><span class="octicon octicon-link"></span></a>Modelで使用可能なアノテーション</h4>

<table>
<thead>
<tr>
<th>アノテーション</th>
<th>説明</th>
<th>サンプル</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/Database" class="user-mention">@Database</a></td>
<td>Modelクラスに対してデータベース設定をする</td>
<td>
<a href="https://github.com/Database" class="user-mention">@Database</a>(driver="WebStream\Database\Driver\Mysql", config="config/database.mysql.ini")</td>
</tr>
<tr>
<td><a href="https://github.com/Query" class="user-mention">@Query</a></td>
<td>読み込むクエリファイルを指定する</td>
<td>
<a href="https://github.com/Query" class="user-mention">@Query</a>(file="query/blog_query.xml")</td>
</tr>
</tbody>
</table>

<h3>
<a id="カスタムアノテーション" class="anchor" href="#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%82%A2%E3%83%8E%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3" aria-hidden="true"><span class="octicon octicon-link"></span></a>カスタムアノテーション</h3>

<p>用意されているアノテーション(デフォルトアノテーション)以外に独自のカスタムアノテーションを定義することができます。</p>

<h4>
<a id="定義方法" class="anchor" href="#%E5%AE%9A%E7%BE%A9%E6%96%B9%E6%B3%95" aria-hidden="true"><span class="octicon octicon-link"></span></a>定義方法</h4>

<p><code>app</code>ディレクトリ以下の任意の場所にクラスを定義します。定義したクラスは自動的にクラスパスが通ります。<br>
クラスの定義は以下のルールに従って定義してください。</p>

<table>
<thead>
<tr>
<th>No</th>
<th>ルール</th>
<th>内容</th>
<th>必須かどうか</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>
<code>@Annotation</code>、<code>@Target</code>をクラスにアノテート</td>
<td>Doctrine Annotationを使用する</td>
<td>必須</td>
</tr>
<tr>
<td>2</td>
<td>
<code>\WebStream\Annotation\Annotation</code>を継承</td>
<td>アノテーション処理実行可能なクラスにする</td>
<td>必須</td>
</tr>
<tr>
<td>3</td>
<td>
<code>Annotation#onInject</code>を実装する</td>
<td>アノテーション初期処理を実行</td>
<td>必須</td>
</tr>
<tr>
<td>4</td>
<td>
<code>IClass</code>を実装する</td>
<td>クラスに対するアノテーションを実行する</td>
<td>任意</td>
</tr>
<tr>
<td>5</td>
<td>
<code>IClass#onClassInject</code>を実装する</td>
<td>クラスに対するアノテーションを実行したときに呼ばれる</td>
<td>IClass実装時は必須</td>
</tr>
<tr>
<td>6</td>
<td>
<code>IMethod</code>を実装する</td>
<td>実行するメソッド(アクションメソッド)に対するアノテーションを実行する</td>
<td>任意</td>
</tr>
<tr>
<td>7</td>
<td>
<code>IMethod#onMethodInject</code>を実装する</td>
<td>メソッド(アクションメソッド)に対するアノテーションを実行する</td>
<td>IMethod実装時は必須</td>
</tr>
<tr>
<td>8</td>
<td>
<code>IMethods</code>を実装する</td>
<td>すべてのメソッドに対するアノテーションを実行する</td>
<td>任意</td>
</tr>
<tr>
<td>9</td>
<td>
<code>IMethods#onMethodInject</code>を実装する</td>
<td>すべてのメソッドに対するアノテーションを実行する</td>
<td>IMethods実装時は必須</td>
</tr>
<tr>
<td>10</td>
<td>
<code>IProperty</code>を実装する</td>
<td>すべてのプロパティに対するアノテーションを実行する</td>
<td>任意</td>
</tr>
<tr>
<td>11</td>
<td>
<code>IProperty#onPropertyInject</code>を実装する</td>
<td>すべてのプロパティに対するアノテーションを実行する</td>
<td>IProperty実装時は必須</td>
</tr>
<tr>
<td>12</td>
<td>
<code>IRead</code>を実装する</td>
<td>アノテーション処理実行後、任意のデータを返却する処理を実行</td>
<td>任意</td>
</tr>
<tr>
<td>13</td>
<td>
<code>IRead#onInjected</code>を実装する</td>
<td>任意のデータを返却する</td>
<td>IRead実装時は必須</td>
</tr>
</tbody>
</table>

<p>デフォルトアノテーションは使用できるレイヤが制限されていますが、カスタムアノテーションはController/Service/Modelレイヤで使用可能です。</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/webstream-framework/WebStream">Webstream</a> is maintained by <a href="https://github.com/webstream-framework">webstream-framework</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
